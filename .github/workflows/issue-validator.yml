name: Issue Validator

on:
  issues:
    types: [opened, edited]

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Check and Label Issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            const title = issue.title || '';

            // Check issue length
            if (body.length < 50) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '## ⚠️ Invalid Issue\n\nThis issue is too short. Please use one of the issue templates:\n- [Bug Report](../../issues/new?template=bug_report.yml)\n- [Feature Request](../../issues/new?template=feature_request.yml)\n- [Documentation](../../issues/new?template=documentation.yml)\n\nThis issue will be closed automatically.'
              });
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['invalid']
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                state: 'closed'
              });
              return;
            }

            // Detect issue type and add labels
            if (title.startsWith('[Bug]') || body.includes('Bug Description')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['bug']
              });
            } else if (title.startsWith('[Feature]') || body.includes('Feature Description')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['enhancement']
              });
            } else if (title.startsWith('[Docs]') || body.includes('Documentation Location')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['documentation']
              });
            } else {
              // No template used
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '## ⚠️ No Template Used\n\nPlease create a new issue using one of our templates:\n- [Bug Report](../../issues/new?template=bug_report.yml)\n- [Feature Request](../../issues/new?template=feature_request.yml)\n- [Documentation](../../issues/new?template=documentation.yml)'
              });
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['invalid']
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                state: 'closed'
              });
            }
